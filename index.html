<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#DD8566">
    <title>Master Tic-Tac-Toe</title>
    
    <link rel="icon" type="image/png" href="favicon.jpeg">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #FFFFFF;
            --text: #474D4D;
            --primary: #DD8566;
            --surface: #F5F5F5;
            --outline: #DBDCDF;
            --radius-btn: 24px;
            --radius-card: 16px;
            --shadow-1: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-2: 0 8px 24px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header & Help Button */
        header { 
            position: relative; width: 100%; max-width: 600px; 
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px;
        }
        h1 { margin: 0; letter-spacing: -0.5px; font-size: 1.8rem; }
        
        .help-btn {
            position: absolute; right: 0; top: 0;
            width: 32px; height: 32px;
            border-radius: 50%; border: 2px solid var(--outline);
            color: var(--primary); font-weight: bold; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; background: transparent;
        }
        .help-btn:hover { background: var(--surface); transform: scale(1.1); }

        /* Screens */
        .screen {
            display: none; width: 100%; max-width: 600px;
            flex-direction: column; align-items: center;
            animation: fadeIn 0.4s ease-out; position: relative; z-index: 10;
        }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin: 20px 0; width: 100%; }
        
        button {
            padding: 14px 28px;
            font-family: 'Roboto', sans-serif; font-size: 1rem; font-weight: 500;
            background-color: var(--bg); border: 1px solid var(--outline);
            color: var(--text); border-radius: var(--radius-btn);
            cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-1);
        }
        button:hover { background-color: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-2); }
        button:active { transform: scale(0.98); }

        input {
            padding: 14px; background: var(--surface); border: none;
            border-bottom: 2px solid var(--outline); color: var(--text);
            text-align: center; font-size: 1.1rem; margin: 10px 0; width: 80%;
            outline: none; transition: 0.2s; border-radius: 4px 4px 0 0;
        }
        input:focus { border-bottom-color: var(--primary); background: #eaeaea; }

        /* Toggles & Codes */
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 0.9rem; color: #777; }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        .code-box {
            background: var(--surface); padding: 15px;
            font-family: 'Roboto Mono', monospace; font-size: 1.5rem;
            border-radius: var(--radius-card); margin: 15px;
            user-select: all; letter-spacing: 2px; color: var(--primary);
            border: 2px dashed var(--outline); cursor: pointer;
        }
        .copy-hint { font-size: 0.8rem; color: #999; margin-top: -10px; margin-bottom: 20px;}

        /* Scoreboard */
        #scoreboard {
            display: flex; justify-content: center; gap: 30px; margin-bottom: 25px;
            background: var(--bg); padding: 15px 30px; border-radius: var(--radius-btn);
            box-shadow: var(--shadow-1); border: 1px solid var(--outline);
        }
        .score-item { text-align: center; }
        .score-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #999; }
        .score-val { font-size: 1.5rem; font-weight: 700; }

        /* Boards */
        #game-wrapper { position: relative; margin-top: 10px; transition: transform 0.5s; width: 100%; display: flex; justify-content: center; }
        #win-line-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: visible; }
        .win-path {
            stroke: var(--primary); stroke-width: 12; stroke-linecap: round;
            fill: none; opacity: 0.85; stroke-dasharray: 1000; stroke-dashoffset: 1000;
            animation: drawLine 0.8s forwards ease-out; filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .cell {
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; cursor: pointer; background: var(--bg);
            transition: background 0.2s; user-select: none; border-radius: 4px;
            position: relative; z-index: 2;
        }
        .cell.x { color: var(--text); }
        .cell.o { color: var(--primary); }
        .cell.highlight { background-color: #FFDBCF !important; transition: background 0.5s; }

        #board-normal {
            display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px);
            gap: 4px; background: var(--outline); padding: 4px; border-radius: 12px;
        }
        #board-normal .cell { font-size: 3rem; }

        /* 3D Board */
        #board-3d {
            display: flex; flex-direction: row; gap: 30px; padding: 40px;
            transform: perspective(1200px) rotateX(30deg) scale(0.9);
            transform-style: preserve-3d; transition: all 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .level-container { position: relative; transform-style: preserve-3d; transition: all 1.2s; }
        .layer-label {
            position: absolute; right: -20px; bottom: -30px; width: 100%; text-align: center;
            transform: rotateX(-30deg); color: #999; font-size: 0.8rem; font-weight: 500; transition: opacity 0.5s;
        }
        .layer-3d {
            display: grid; grid-template-columns: repeat(3, 50px); grid-template-rows: repeat(3, 50px);
            gap: 4px; padding: 8px; background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(221, 133, 102, 0.3); border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); transform: translateZ(0); transition: all 1.2s;
        }
        #board-3d .cell { font-size: 1.5rem; width: 50px; height: 50px; background: rgba(245, 245, 245, 0.6); }
        
        #board-3d.stacked { transform: perspective(1200px) rotateX(10deg) scale(1); gap: 0; flex-direction: column; }
        #board-3d.stacked .level-container { margin-top: -160px; opacity: 0.8; }
        #board-3d.stacked .level-container:first-child { margin-top: 0; opacity: 1; }
        #board-3d.stacked .layer-label { opacity: 0; }

        /* Ultimate Board */
        #board-ultimate {
            display: grid; grid-template-columns: repeat(3, auto); gap: 6px;
            background: var(--text); padding: 6px; border-radius: 12px;
        }
        .sub-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; 
            background: var(--outline); padding: 2px; position: relative;
        }
        .sub-grid.active-zone { background: #FFDBCF; }
        .sub-grid.won-x::after, .sub-grid.won-o::after {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; font-weight: 900; z-index: 10; line-height: 1; pointer-events: none;
            animation: popIn 0.3s;
        }
        .sub-grid.won-x::after { content: "X"; color: var(--text); opacity: 0.9; }
        .sub-grid.won-o::after { content: "O"; color: var(--primary); opacity: 0.9; }
        .sub-grid.won-x .cell, .sub-grid.won-o .cell { opacity: 0.2; }
        #board-ultimate .cell { width: 32px; height: 32px; font-size: 1rem; background: var(--bg); }

        .back-link { background: transparent; color: #999; border: none; box-shadow: none; text-decoration: underline; margin-top: 20px;}
        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal {
            background: white; padding: 30px; border-radius: var(--radius-card);
            max-width: 500px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal ul { text-align: left; padding-left: 20px; color: #666; line-height: 1.6; }

        #toast {
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 16px; position: fixed;
            z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        /* Mobile Tweaks */
        @media (max-width: 600px) {
            #board-3d { flex-direction: column; gap: 20px; transform: perspective(1200px) rotateX(30deg) scale(0.8); }
            #board-3d.stacked { margin-top: 100px; }
            .layer-label { right: auto; left: 50%; transform: translateX(-50%) rotateX(-30deg); bottom: -25px; }
            #board-normal { grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(3, 70px); }
            #board-normal .cell { font-size: 2.5rem; }
        }

    </style>
</head>
<body>

    <header>
        <h1>Master Tic-Tac-Toe</h1>
        <button class="help-btn" onclick="toggleModal(true)">?</button>
    </header>

    <div id="screen-start" class="screen active">
        <h2>Select Mode</h2>
        <div class="btn-group">
            <button onclick="setupLocal()">Pass & Play</button>
            <button onclick="setupBot()">vs Bot</button>
            <button onclick="setupMultiplayerMenu()">Multiplayer</button>
        </div>
        <div class="toggle-wrapper">
            <label class="switch"><input type="checkbox" id="anim-toggle" checked><span class="slider"></span></label>
            <span>Cinematic Win Effects</span>
        </div>
    </div>

    <div id="screen-local-setup" class="screen">
        <h2>Enter Names</h2>
        <input type="text" id="local-p1" placeholder="Player 1 (X)" value="Player 1">
        <input type="text" id="local-p2" placeholder="Player 2 (O)" value="Player 2">
        <div class="btn-group"><button onclick="finishSetup('local')">Next</button></div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-mp-menu" class="screen">
        <h2>Multiplayer</h2>
        <input type="text" id="mp-name" placeholder="Your Name" value="Player">
        <div class="btn-group"><button onclick="setupHost()">Host Game</button></div>
        <p>OR</p>
        <div class="btn-group" style="align-items: center;">
            <input type="text" id="join-code" class="code-input" placeholder="9-CHAR CODE" maxlength="9" style="margin: 0; border-radius: 8px;">
        </div>
        <div class="btn-group"><button id="btn-join" onclick="joinGame()">Join Game</button></div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-variant" class="screen">
        <h2>Select Game Type</h2>
        <div class="btn-group">
            <button onclick="selectVariant('normal')">Normal (3x3)</button>
            <button onclick="selectVariant('3d')">3D (3x3x3)</button>
            <button onclick="selectVariant('ultimate')">Ultimate</button>
        </div>
        <button class="back-link" onclick="goBack('screen-start')">Back</button>
    </div>

    <div id="screen-host-waiting" class="screen">
        <h2>Waiting for Opponent</h2>
        <p>Share this link or code:</p>
        <div id="host-code-display" class="code-box" onclick="copyJoinLink()">Generating...</div>
        <div class="copy-hint">(Tap box to copy link)</div>
        <p>Mode: <strong id="host-selected-mode" style="color:var(--primary)">-</strong></p>
        <div id="host-status" style="font-style: italic; color: #999;">Waiting for connection...</div>
        <button class="back-link" onclick="goBack('screen-mp-menu')">Cancel</button>
    </div>

    <div id="screen-difficulty" class="screen">
        <h2>Select Difficulty</h2>
        <div class="btn-group">
            <button onclick="startGameBot('easy')">Easy</button>
            <button onclick="startGameBot('medium')">Medium</button>
            <button onclick="startGameBot('hard')">Hard</button>
        </div>
        <button class="back-link" onclick="goBack('screen-variant')">Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="scoreboard">
            <div class="score-item"><div class="score-label" id="score-name-1">P1</div><div id="score-val-1" class="score-val">0</div></div>
            <div class="score-item"><div class="score-label">Draws</div><div id="score-val-draw" class="score-val" style="color:#bbb;">0</div></div>
            <div class="score-item"><div class="score-label" id="score-name-2">P2</div><div id="score-val-2" class="score-val">0</div></div>
        </div>
        <h3 id="game-title" style="color: #bbb; font-weight: 500;">TIC-TAC-TOE</h3>
        <div id="turn-display">X's Turn</div>

        <div id="game-wrapper">
            <svg id="win-line-svg"></svg>
            <div id="board-container"></div>
        </div>

        <button id="restart-btn" style="margin-top: 30px; display:none;" onclick="triggerRestart()">Play Next Round</button>
        <button class="back-link" onclick="location.href = window.location.pathname">Exit to Menu</button>
    </div>

    <div class="modal-overlay" id="rules-modal" onclick="toggleModal(false)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>How to Play</h3>
            <p><strong>Normal (3x3):</strong> Get 3 in a row to win.</p>
            <p><strong>3D (3x3x3):</strong> Imagine 3 boards stacked. You can win on one board, or straight down through the stack, or diagonally through the cube.</p>
            <p><strong>Ultimate:</strong></p>
            <ul>
                <li>The board has 9 mini-games.</li>
                <li>If X plays in the top-right cell of a mini-game, O <strong>must</strong> play in the top-right mini-game next.</li>
                <li>Win a mini-game to mark that large square.</li>
                <li>Get 3 large squares in a row to win the game!</li>
            </ul>
            <button onclick="toggleModal(false)" style="width:100%">Got it</button>
        </div>
    </div>

    <div id="toast">Link Copied!</div>

<script>
    /* --- GLOBAL STATE --- */
    const state = {
        screen: 'screen-start',
        mode: null, variant: null, difficulty: null,
        p1Name: "Player 1", p2Name: "Player 2",
        scores: { p1: 0, p2: 0, draw: 0 },
        board: [], turn: 'X', myPlayer: 'X', active: false,
        ultimateMacro: [], activeSubGrid: -1,
        peer: null, conn: null, hostId: null,
        animationsEnabled: true
    };

    /* --- INITIALIZATION --- */
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinCode = urlParams.get('join');
        if (joinCode) {
            showScreen('screen-mp-menu');
            document.getElementById('join-code').value = joinCode;
            document.getElementById('mp-name').focus();
        }
    });

    document.getElementById('anim-toggle').addEventListener('change', (e) => state.animationsEnabled = e.target.checked);

    function toggleModal(show) {
        document.getElementById('rules-modal').style.display = show ? 'flex' : 'none';
    }

    /* --- NAVIGATION --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        state.screen = id;
    }
    function goBack(target) { if (state.peer) { state.peer.destroy(); state.peer = null; } showScreen(target); }

    /* --- SETUP FLOWS --- */
    function setupLocal() { state.mode = 'local'; showScreen('screen-local-setup'); }
    function setupBot() { state.mode = 'bot'; state.p1Name = "You"; state.p2Name = "Bot"; showScreen('screen-variant'); }
    function setupMultiplayerMenu() { showScreen('screen-mp-menu'); }
    function setupHost() { state.mode = 'host'; state.p1Name = document.getElementById('mp-name').value || "Host"; showScreen('screen-variant'); }
    function finishSetup(from) {
        if (from === 'local') {
            state.p1Name = document.getElementById('local-p1').value || "Player 1";
            state.p2Name = document.getElementById('local-p2').value || "Player 2";
            showScreen('screen-variant');
        }
    }
    function selectVariant(v) {
        state.variant = v;
        if (state.mode === 'bot') showScreen('screen-difficulty');
        else if (state.mode === 'host') startHostingProcess();
        else initGame(v);
    }
    function startGameBot(d) { state.difficulty = d; state.p2Name = "Bot ("+d+")"; state.myPlayer = 'X'; initGame(state.variant); }

    /* --- GAME INIT --- */
    function initGame(variant) {
        showScreen('screen-game');
        state.active = true; state.turn = 'X'; state.board = [];
        state.ultimateMacro = Array(9).fill(null); state.activeSubGrid = -1;
        
        document.getElementById('win-line-svg').innerHTML = '';
        const board3d = document.getElementById('board-3d');
        if(board3d) board3d.classList.remove('stacked');
        
        document.getElementById('restart-btn').style.display = 'none';
        document.getElementById('game-title').innerText = variant.toUpperCase();
        updateScoreboard(); updateTurnDisplay();

        const container = document.getElementById('board-container');
        container.innerHTML = '';

        if (variant === 'normal') initNormal(container);
        else if (variant === '3d') init3D(container);
        else if (variant === 'ultimate') initUltimate(container);
    }

    function updateScoreboard() {
        document.getElementById('score-name-1').innerText = state.p1Name + " (X)";
        document.getElementById('score-name-2').innerText = state.p2Name + " (O)";
        document.getElementById('score-val-1').innerText = state.scores.p1;
        document.getElementById('score-val-2').innerText = state.scores.p2;
        document.getElementById('score-val-draw').innerText = state.scores.draw;
    }

    /* --- RENDERERS --- */
    function createCell(idx) {
        const c = document.createElement('div'); c.className = 'cell'; c.dataset.idx = idx; c.onclick = () => handleInput(idx); return c;
    }
    function initNormal(con) {
        const g = document.createElement('div'); g.id = 'board-normal'; state.board = Array(9).fill(null);
        for(let i=0;i<9;i++) g.appendChild(createCell(i)); con.appendChild(g);
    }
    function init3D(con) {
        const w = document.createElement('div'); w.id = 'board-3d'; state.board = Array(27).fill(null);
        for(let z=0;z<3;z++) {
            const lb = document.createElement('div'); lb.className = 'level-container'; lb.id = `lvl-${z}`;
            const lbl = document.createElement('div'); lbl.className = 'layer-label'; lbl.innerText = `Level ${z+1}`; lb.appendChild(lbl);
            const l = document.createElement('div'); l.className = 'layer-3d';
            for(let y=0;y<3;y++) for(let x=0;x<3;x++) l.appendChild(createCell(z*9+y*3+x));
            lb.appendChild(l); w.appendChild(lb);
        }
        con.appendChild(w);
    }
    function initUltimate(con) {
        const g = document.createElement('div'); g.id = 'board-ultimate'; state.board = Array(81).fill(null);
        for(let i=0;i<9;i++) {
            const s = document.createElement('div'); s.className = 'sub-grid active-zone'; s.id = `sub-${i}`;
            for(let j=0;j<9;j++) s.appendChild(createCell(i*9+j)); g.appendChild(s);
        }
        con.appendChild(g);
    }

    /* --- INPUT HANDLING --- */
    function handleInput(idx) {
        if (!state.active) return;
        if (state.mode !== 'local' && state.turn !== state.myPlayer) return;
        if (!isValidMove(idx)) return;

        makeMove(idx, state.turn);
        if ((state.mode === 'host' || state.mode === 'join') && state.conn) state.conn.send({ type: 'move', idx: idx });
        if (state.mode === 'bot' && state.active) setTimeout(botMove, 500);
    }

    function isValidMove(idx) {
        if (state.board[idx] !== null) return false;
        if (state.variant === 'ultimate') {
            const s = Math.floor(idx/9);
            if (state.activeSubGrid !== -1 && s !== state.activeSubGrid) return false;
            if (state.ultimateMacro[s] !== null) return false;
        }
        return true;
    }

    function makeMove(idx, p) {
        state.board[idx] = p; renderCell(idx, p);
        let winLine = null;
        if (state.variant === 'normal') winLine = checkWinNormal(state.board, p);
        else if (state.variant === '3d') winLine = checkWin3D(state.board, p);
        else if (state.variant === 'ultimate') winLine = handleUltimateMove(idx, p);

        if (winLine) endGame(p, winLine);
        else if (isDraw()) endGame('draw');
        else {
            state.turn = state.turn === 'X' ? 'O' : 'X'; updateTurnDisplay();
            if (state.variant === 'ultimate') highlightActiveSubGrids();
        }
    }

    function renderCell(idx, p) {
        let el;
        if(state.variant==='normal') el=document.querySelector(`#board-normal .cell[data-idx='${idx}']`);
        else if(state.variant==='3d') el=document.querySelector(`.layer-3d .cell[data-idx='${idx}']`);
        else el=document.querySelector(`#board-ultimate .cell[data-idx='${idx}']`);
        if(el){ el.innerHTML = `<span>${p}</span>`; el.classList.add(p.toLowerCase(), 'taken'); }
    }

    function updateTurnDisplay() {
        const el = document.getElementById('turn-display'); const pName = state.turn === 'X' ? state.p1Name : state.p2Name;
        if (state.mode === 'local') { el.innerText = `${pName}'s Turn (${state.turn})`; el.style.color = state.turn === 'X' ? "var(--text)" : "var(--primary)"; }
        else { el.innerText = state.turn === state.myPlayer ? "Your Turn" : `${pName}'s Turn`; el.style.color = state.turn === state.myPlayer ? "var(--primary)" : "#999"; }
    }

    /* --- END GAME & ANIMATIONS --- */
    function endGame(res, winLine) {
        state.active = false;
        const display = document.getElementById('turn-display');
        
        if (res === 'draw') {
            display.innerText = "It's a Draw!"; state.scores.draw++;
            updateScoreboard(); document.getElementById('restart-btn').style.display = 'inline-block';
        } else {
            const wName = res === 'X' ? state.p1Name : state.p2Name;
            display.innerText = `${wName} Wins!`;
            display.style.color = res === 'X' ? "var(--text)" : "var(--primary)";
            if (res === 'X') state.scores.p1++; else state.scores.p2++;
            updateScoreboard();

            if (state.animationsEnabled && state.variant === '3d' && winLine) {
                perform3DWin(winLine, () => showWinEffects(winLine));
            } else if (state.animationsEnabled && winLine) {
                showWinEffects(winLine);
            } else {
                fireConfetti();
                document.getElementById('restart-btn').style.display = 'inline-block';
            }
        }
    }

    function highlightCells(indices) {
        indices.forEach(idx => {
            let el;
            if(state.variant==='normal') el=document.querySelector(`#board-normal .cell[data-idx='${idx}']`);
            else if(state.variant==='3d') el=document.querySelector(`.layer-3d .cell[data-idx='${idx}']`);
            else if(state.variant==='ultimate') el=document.getElementById(`sub-${idx}`); 
            
            if(el) {
                if(state.variant === 'ultimate') el.style.boxShadow = "inset 0 0 0 4px var(--primary)";
                else el.classList.add('highlight');
            }
        });
    }

    function showWinEffects(line) {
        highlightCells(line);
        drawSVGLine(line);
        fireConfetti();
        setTimeout(() => { document.getElementById('restart-btn').style.display = 'inline-block'; }, 1000);
    }

    function perform3DWin(line, callback) {
        const board3d = document.getElementById('board-3d');
        board3d.classList.add('stacked');
        setTimeout(callback, 1200); 
    }

    function drawSVGLine(indices) {
        if (!indices || indices.length === 0) return;
        const startIdx = indices[0];
        const endIdx = indices[indices.length - 1];

        const getCenter = (idx) => {
            let el;
            if(state.variant==='normal') el=document.querySelector(`#board-normal .cell[data-idx='${idx}']`);
            else if(state.variant==='3d') el=document.querySelector(`.layer-3d .cell[data-idx='${idx}']`);
            else if(state.variant==='ultimate') el=document.getElementById(`sub-${idx}`);
            
            if(!el) return {x:0, y:0};
            const rect = el.getBoundingClientRect();
            const wrapperRect = document.getElementById('game-wrapper').getBoundingClientRect();
            return {
                x: rect.left + rect.width/2 - wrapperRect.left,
                y: rect.top + rect.height/2 - wrapperRect.top
            };
        };

        const start = getCenter(startIdx);
        const end = getCenter(endIdx);

        const svg = document.getElementById('win-line-svg');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${start.x} ${start.y} L ${end.x} ${end.y}`);
        path.setAttribute('class', 'win-path');
        svg.appendChild(path);
    }

    function fireConfetti() { if(window.confetti) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#DD8566', '#474D4D'] }); }

    /* --- LOGIC HELPERS --- */
    const WINS_3X3 = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    function checkWinNormal(b, p) { 
        for(let c of WINS_3X3) if(c.every(i => b[i] === p)) return c;
        return null; 
    }
    function checkWin3D(b, p) {
        const checkLine = (sx,sy,sz, dx,dy,dz) => {
            let line = [];
            for(let i=0; i<3; i++) {
                let idx = (sz+i*dz)*9 + (sy+i*dy)*3 + (sx+i*dx);
                if (b[idx] !== p) return null;
                line.push(idx);
            }
            return line;
        };
        let l;
        for(let z=0; z<3; z++) for(let y=0; y<3; y++) if(l=checkLine(0,y,z, 1,0,0)) return l;
        for(let z=0; z<3; z++) for(let x=0; x<3; x++) if(l=checkLine(x,0,z, 0,1,0)) return l;
        for(let y=0; y<3; y++) for(let x=0; x<3; x++) if(l=checkLine(x,y,0, 0,0,1)) return l;
        for(let z=0; z<3; z++) { if(l=checkLine(0,0,z, 1,1,0)) return l; if(l=checkLine(2,0,z, -1,1,0)) return l; }
        for(let y=0; y<3; y++) { if(l=checkLine(0,y,0, 1,0,1)) return l; if(l=checkLine(2,y,0, -1,0,1)) return l; }
        for(let x=0; x<3; x++) { if(l=checkLine(x,0,0, 0,1,1)) return l; if(l=checkLine(x,2,0, 0,-1,1)) return l; }
        if(l=checkLine(0,0,0, 1,1,1)) return l; if(l=checkLine(2,0,0, -1,1,1)) return l;
        if(l=checkLine(0,2,0, 1,-1,1)) return l; if(l=checkLine(2,2,0, -1,-1,1)) return l;
        return null;
    }
    function handleUltimateMove(idx, p) {
        const s = Math.floor(idx/9);
        const subArr = state.board.slice(s*9, s*9+9);
        if (state.ultimateMacro[s] === null && checkWinNormal(subArr, p)) {
            state.ultimateMacro[s] = p; 
            document.getElementById(`sub-${s}`).classList.add(p==='X'?'won-x':'won-o');
        }
        const rel = idx % 9;
        state.activeSubGrid = (state.ultimateMacro[rel] !== null || isSubGridFull(rel)) ? -1 : rel;
        highlightActiveSubGrids();
        return checkWinNormal(state.ultimateMacro, p);
    }
    function highlightActiveSubGrids() {
        for(let i=0;i<9;i++) {
            const el = document.getElementById(`sub-${i}`); el.classList.remove('active-zone');
            if(!state.ultimateMacro[i] && (state.activeSubGrid===-1 || state.activeSubGrid===i)) el.classList.add('active-zone');
        }
    }
    function isSubGridFull(i) { for(let k=0;k<9;k++) if(state.board[i*9+k]===null) return false; return true; }
    function isDraw() { return state.board.every(c => c !== null); }

    /* --- BOT --- */
    function botMove() {
        let moves=[]; for(let i=0;i<state.board.length;i++) if(isValidMove(i)) moves.push(i);
        if(moves.length===0) return;
        let idx = -1;
        if(state.difficulty==='easy') idx = moves[Math.floor(Math.random()*moves.length)];
        else {
            if(Math.random() > (state.difficulty==='medium'?0.7:0.95)) idx = moves[Math.floor(Math.random()*moves.length)];
            else idx = findBestMove(moves);
        }
        makeMove(idx, 'O');
    }
    function findBestMove(moves) {
        for(let m of moves) { let t=[...state.board]; t[m]='O'; if(checkWinSim(t,'O')) return m; }
        for(let m of moves) { let t=[...state.board]; t[m]='X'; if(checkWinSim(t,'X')) return m; }
        return moves[Math.floor(Math.random()*moves.length)];
    }
    function checkWinSim(b, p) { return state.variant==='normal'?checkWinNormal(b,p): (state.variant==='3d'?checkWin3D(b,p):false); }

    /* --- NETWORK --- */
    function makeId(l) { const c='abcdefghijklmnopqrstuvwxyz0123456789'; let r=''; for(let i=0;i<l;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r; }
    function startHostingProcess() {
        showScreen('screen-host-waiting'); document.getElementById('host-selected-mode').innerText = state.variant.toUpperCase();
        state.hostId = makeId(9);
        state.peer = new Peer(state.hostId);
        state.peer.on('open', (id) => { document.getElementById('host-code-display').innerText = id; });
        state.peer.on('error', () => { state.peer.destroy(); startHostingProcess(); });
        state.peer.on('connection', (c) => {
            state.conn = c; document.getElementById('host-status').innerText = "Connecting..."; setupConn();
            c.on('open', () => {
                c.send({ type: 'start', variant: state.variant, hostName: state.p1Name });
                state.myPlayer = 'X'; initGame(state.variant);
            });
        });
    }
    function joinGame() {
        state.mode = 'join'; const name = document.getElementById('mp-name').value || "Joiner";
        const code = document.getElementById('join-code').value.trim().toLowerCase();
        if (!code) return alert("Enter Code");
        state.p2Name = name; document.getElementById('btn-join').innerText = "Connecting...";
        state.peer = new Peer(); 
        state.peer.on('open', () => { state.conn = state.peer.connect(code); setupConn(); });
        state.peer.on('error', () => { alert("Connection Failed"); location.reload(); });
    }
    function setupConn() {
        state.conn.on('data', (d) => {
            if(d.type==='start'){ state.variant=d.variant; state.p1Name=d.hostName; state.p2Name=document.getElementById('mp-name').value; state.conn.send({type:'name-ack',name:state.p2Name}); state.myPlayer='O'; initGame(state.variant); }
            if(d.type==='name-ack'){ state.p2Name=d.name; updateScoreboard(); updateTurnDisplay(); }
            if(d.type==='move') makeMove(d.idx, state.myPlayer==='X'?'O':'X');
            if(d.type==='restart') initGame(state.variant);
        });
        state.conn.on('close', () => alert("Opponent Disconnected"));
    }
    function triggerRestart() { initGame(state.variant); if((state.mode==='host'||state.mode==='join')&&state.conn) state.conn.send({type:'restart'}); }

    function copyJoinLink() {
        const id = document.getElementById('host-code-display').innerText;
        if(id === 'Generating...') return;
        const link = window.location.origin + window.location.pathname + '?join=' + id;
        navigator.clipboard.writeText(link).then(() => {
            const t = document.getElementById('toast'); t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        });
    }
</script>
</body>
</html>
