<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Tic-Tac-Toe Suite</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --error: #cf6679;
            --on-bg: #ffffff;
            --grid-line: #333;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--on-bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3 { text-align: center; margin: 10px 0; }
        
        /* --- UI Screens --- */
        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            align-items: center;
        }
        .active { display: flex; }

        /* --- Buttons & Inputs --- */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 15px 0; }
        
        button {
            padding: 12px 24px;
            font-size: 1rem;
            background: var(--surface);
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { background: var(--primary); color: var(--bg); transform: scale(1.05); }
        
        input {
            padding: 12px;
            background: var(--surface);
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            text-align: center;
            font-size: 1rem;
            margin: 5px;
        }
        .code-input { text-transform: uppercase; letter-spacing: 2px; }

        .code-box {
            background: black;
            padding: 10px;
            font-family: monospace;
            font-size: 1.5rem;
            border: 1px dashed var(--secondary);
            margin: 10px;
            user-select: all;
            letter-spacing: 2px;
            color: var(--secondary);
        }

        /* --- Scoreboard --- */
        #scoreboard {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            background: var(--surface);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }
        .score-item { text-align: center; }
        .score-val { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }

        /* --- Game Board Styles --- */
        
        /* Generic Cell */
        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            background: var(--surface);
            transition: background 0.2s;
        }
        /* Animation for placing a piece */
        .cell.taken span {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .cell.x { color: var(--secondary); }
        .cell.o { color: var(--primary); }
        .cell:hover:not(.taken) { filter: brightness(1.2); }

        /* 1. Normal 3x3 */
        #board-normal {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 5px;
            background: var(--grid-line);
            padding: 5px;
        }
        #board-normal .cell { font-size: 2.5rem; }

        /* 2. 3D 3x3x3 */
        #board-3d {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .layer-3d {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 3px;
            background: var(--grid-line);
            padding: 3px;
            transform: rotateX(15deg);
        }
        .layer-label { text-align: center; margin-bottom: 5px; color: #888; }
        #board-3d .cell { font-size: 1.5rem; width: 50px; height: 50px; }

        /* 3. Ultimate Fixed Styles */
        #board-ultimate {
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 10px;
            background: #444; 
            padding: 10px;
            margin: 0 auto;
        }

        .sub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            background: var(--grid-line);
            padding: 2px;
        }
        .sub-grid.active-zone { background: var(--secondary); }
        .sub-grid.won-x { background: rgba(3, 218, 198, 0.3); }
        .sub-grid.won-o { background: rgba(187, 134, 252, 0.3); }

        #board-ultimate .cell {
            width: 35px;
            height: 35px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #turn-display { margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
        #restart-btn { display: none; background: var(--secondary); color: black; border: none; font-weight: bold; margin-top: 20px;}

    </style>
</head>
<body>

    <h1>Master Tic-Tac-Toe</h1>

    <div id="screen-start" class="screen active">
        <h2>Select Opponent</h2>
        <div class="btn-group">
            <button onclick="setupLocal()">Local (Pass & Play)</button>
            <button onclick="setupBot()">Single Player (vs Bot)</button>
            <button onclick="setupMultiplayer()">Multiplayer (Online)</button>
        </div>
    </div>

    <div id="screen-local-setup" class="screen">
        <h2>Enter Names</h2>
        <input type="text" id="local-p1" placeholder="Player 1 Name (X)" value="Player 1">
        <input type="text" id="local-p2" placeholder="Player 2 Name (O)" value="Player 2">
        <button onclick="finishSetup('local')">Next: Select Game</button>
        <button onclick="goBack('screen-start')" style="background:transparent; color:#666;">Back</button>
    </div>

    <div id="screen-variant" class="screen">
        <h2>Select Game Type</h2>
        <div class="btn-group">
            <button onclick="selectVariant('normal')">Normal (3x3)</button>
            <button onclick="selectVariant('3d')">3D (3x3x3)</button>
            <button onclick="selectVariant('ultimate')">Ultimate</button>
        </div>
        <button onclick="goBack('screen-start')" style="margin-top:20px; font-size:0.8rem">Back</button>
    </div>

    <div id="screen-difficulty" class="screen">
        <h2>Select Difficulty</h2>
        <div class="btn-group">
            <button onclick="startGameBot('easy')">Easy</button>
            <button onclick="startGameBot('medium')">Medium</button>
            <button onclick="startGameBot('hard')">Hard</button>
        </div>
        <button onclick="goBack('screen-variant')" style="margin-top:20px; font-size:0.8rem">Back</button>
    </div>

    <div id="screen-multiplayer" class="screen">
        <h2>Multiplayer Setup</h2>
        <input type="text" id="mp-name" placeholder="Your Name" value="Player">
        <div id="mp-menu" style="margin-top: 15px;">
            <button onclick="hostGame()">Host Game</button>
            <span style="margin: 0 10px;">OR</span>
            <input type="text" id="join-code" class="code-input" placeholder="Enter 9-char Code" maxlength="9">
            <button onclick="joinGame()">Join Game</button>
        </div>

        <div id="mp-host-area" style="display:none; text-align: center;">
            <p>Your Game Code:</p>
            <div id="host-code-display" class="code-box">...</div>
            <p>Waiting for opponent...</p>
        </div>

        <div id="mp-status" style="display:none; color: var(--secondary);">Connecting...</div>
        <button onclick="goBack('screen-start')" style="margin-top:20px; font-size:0.8rem">Back</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="scoreboard">
            <div class="score-item">
                <div id="score-name-1">Player 1</div>
                <div id="score-val-1" class="score-val">0</div>
            </div>
            <div class="score-item">
                <div>Draws</div>
                <div id="score-val-draw" class="score-val" style="color:#888;">0</div>
            </div>
            <div class="score-item">
                <div id="score-name-2">Player 2</div>
                <div id="score-val-2" class="score-val">0</div>
            </div>
        </div>

        <h3 id="game-title" style="color: #666; margin-bottom: 5px;">Tic-Tac-Toe</h3>
        <div id="turn-display">X's Turn</div>

        <div id="board-container" style="margin-top: 20px;"></div>

        <button id="restart-btn" onclick="triggerRestart()">Play Next Round</button>
        <button onclick="location.reload()" style="margin-top: 20px; background: transparent; color: #666; border: none; font-size: 0.8rem;">Exit to Menu</button>
    </div>

<script>
    /* --- GLOBAL STATE --- */
    const state = {
        screen: 'screen-start',
        mode: null, // 'local', 'bot', 'human'
        variant: null,  
        difficulty: null,
        
        // Players
        p1Name: "Player 1",
        p2Name: "Player 2",
        scores: { p1: 0, p2: 0, draw: 0 },

        // Game Logic
        board: [], 
        turn: 'X',
        myPlayer: 'X', // In Local, this is ignored. In Network/Bot, this is who YOU are.
        active: false,
        
        // Ultimate Specific
        ultimateMacro: [], 
        activeSubGrid: -1, 

        // Network
        peer: null,
        conn: null
    };

    /* --- NAVIGATION --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        state.screen = id;
    }

    function goBack(target) { 
        if (state.peer) { state.peer.destroy(); state.peer = null; }
        showScreen(target); 
    }

    /* --- SETUP FLOWS --- */
    function setupLocal() {
        state.mode = 'local';
        showScreen('screen-local-setup');
    }

    function setupBot() {
        state.mode = 'bot';
        state.p1Name = "You";
        state.p2Name = "Bot";
        showScreen('screen-variant');
    }

    function setupMultiplayer() {
        state.mode = 'human';
        showScreen('screen-multiplayer');
    }

    function finishSetup(from) {
        if (from === 'local') {
            state.p1Name = document.getElementById('local-p1').value || "Player 1";
            state.p2Name = document.getElementById('local-p2').value || "Player 2";
            showScreen('screen-variant');
        }
    }

    function selectVariant(v) {
        state.variant = v;
        if (state.mode === 'bot') showScreen('screen-difficulty');
        else if (state.mode === 'human') showScreen('screen-multiplayer');
        else initGame(v); // Local goes straight to game
    }

    function startGameBot(diff) {
        state.difficulty = diff;
        state.p2Name = "Bot (" + diff + ")";
        state.myPlayer = 'X'; 
        initGame(state.variant);
    }

    /* --- GAME INITIALIZATION --- */
    function initGame(variant) {
        showScreen('screen-game');
        state.active = true;
        state.turn = 'X';
        state.board = [];
        state.ultimateMacro = Array(9).fill(null);
        state.activeSubGrid = -1;

        // UI Reset
        document.getElementById('restart-btn').style.display = 'none';
        document.getElementById('game-title').innerText = variant.toUpperCase();
        updateScoreboard();
        updateTurnDisplay();

        const container = document.getElementById('board-container');
        container.innerHTML = '';

        if (variant === 'normal') initNormal(container);
        else if (variant === '3d') init3D(container);
        else if (variant === 'ultimate') initUltimate(container);
    }

    function updateScoreboard() {
        document.getElementById('score-name-1').innerText = state.p1Name + " (X)";
        document.getElementById('score-name-2').innerText = state.p2Name + " (O)";
        document.getElementById('score-val-1').innerText = state.scores.p1;
        document.getElementById('score-val-2').innerText = state.scores.p2;
        document.getElementById('score-val-draw').innerText = state.scores.draw;
    }

    /* --- RENDERERS --- */
    function initNormal(container) {
        const grid = document.createElement('div');
        grid.id = 'board-normal';
        state.board = Array(9).fill(null);
        for (let i = 0; i < 9; i++) {
            grid.appendChild(createCell(i));
        }
        container.appendChild(grid);
    }

    function init3D(container) {
        const wrapper = document.createElement('div');
        wrapper.id = 'board-3d';
        state.board = Array(27).fill(null); 
        for (let z = 0; z < 3; z++) {
            const layerBox = document.createElement('div');
            layerBox.className = 'level-container';
            const label = document.createElement('div');
            label.className = 'layer-label';
            label.innerText = `Level ${z+1}`;
            layerBox.appendChild(label);
            const layer = document.createElement('div');
            layer.className = 'layer-3d';
            for (let y = 0; y < 3; y++) {
                for (let x = 0; x < 3; x++) {
                    layer.appendChild(createCell(z*9 + y*3 + x));
                }
            }
            layerBox.appendChild(layer);
            wrapper.appendChild(layerBox);
        }
        container.appendChild(wrapper);
    }

    function initUltimate(container) {
        const grid = document.createElement('div');
        grid.id = 'board-ultimate';
        state.board = Array(81).fill(null); 
        for (let i = 0; i < 9; i++) {
            const sub = document.createElement('div');
            sub.className = 'sub-grid active-zone'; 
            sub.id = `sub-${i}`;
            for (let j = 0; j < 9; j++) {
                sub.appendChild(createCell(i*9 + j));
            }
            grid.appendChild(sub);
        }
        container.appendChild(grid);
    }

    function createCell(idx) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.idx = idx;
        cell.onclick = () => handleInput(idx);
        return cell;
    }

    /* --- INPUT HANDLING --- */
    function handleInput(idx) {
        if (!state.active) return;
        
        // Turn Validation
        if (state.mode !== 'local') {
            if (state.turn !== state.myPlayer) return; 
        }

        if (!isValidMove(idx)) return;

        makeMove(idx, state.turn);
        
        // Networking & Bot
        if (state.mode === 'human' && state.conn) {
            state.conn.send({ type: 'move', idx: idx });
        }
        if (state.mode === 'bot' && state.active) {
            setTimeout(botMove, 500); 
        }
    }

    function isValidMove(idx) {
        if (state.board[idx] !== null) return false;
        if (state.variant === 'ultimate') {
            const subGridIdx = Math.floor(idx / 9);
            if (state.activeSubGrid !== -1 && subGridIdx !== state.activeSubGrid) return false;
            if (state.ultimateMacro[subGridIdx] !== null) return false;
        }
        return true;
    }

    function makeMove(idx, player) {
        state.board[idx] = player;
        renderCell(idx, player);

        let won = false;
        if (state.variant === 'normal') won = checkWinNormal(state.board, player);
        else if (state.variant === '3d') won = checkWin3D(state.board, player);
        else if (state.variant === 'ultimate') won = handleUltimateMove(idx, player);

        if (won) {
            endGame(player);
        } else if (isDraw()) {
            endGame('draw');
        } else {
            state.turn = state.turn === 'X' ? 'O' : 'X';
            updateTurnDisplay();
            if (state.variant === 'ultimate') highlightActiveSubGrids();
        }
    }

    function renderCell(idx, player) {
        let el;
        if(state.variant === 'normal') el = document.querySelector(`#board-normal .cell[data-idx='${idx}']`);
        else if(state.variant === '3d') el = document.querySelector(`.layer-3d .cell[data-idx='${idx}']`);
        else if(state.variant === 'ultimate') el = document.querySelector(`#board-ultimate .cell[data-idx='${idx}']`);
        
        if (el) {
            el.innerHTML = `<span>${player}</span>`; // Wrap in span for animation
            el.classList.add(player.toLowerCase(), 'taken');
        }
    }

    /* --- GAME STATE UPDATES --- */
    function updateTurnDisplay() {
        const el = document.getElementById('turn-display');
        const pName = state.turn === 'X' ? state.p1Name : state.p2Name;
        
        if (state.mode === 'local') {
            el.innerText = `${pName}'s Turn (${state.turn})`;
            el.style.color = state.turn === 'X' ? "var(--secondary)" : "var(--primary)";
        } else {
            if (state.turn === state.myPlayer) {
                el.innerText = "Your Turn";
                el.style.color = "var(--secondary)";
            } else {
                el.innerText = `${pName}'s Turn`;
                el.style.color = "var(--on-bg)";
            }
        }
    }

    function endGame(result) {
        state.active = false;
        const display = document.getElementById('turn-display');
        
        if (result === 'draw') {
            display.innerText = "It's a Draw!";
            state.scores.draw++;
        } else {
            const winnerName = result === 'X' ? state.p1Name : state.p2Name;
            display.innerText = `${winnerName} Wins!`;
            display.style.color = result === 'X' ? "var(--secondary)" : "var(--primary)";
            
            if (result === 'X') state.scores.p1++;
            else state.scores.p2++;
            
            fireConfetti();
        }
        updateScoreboard();
        document.getElementById('restart-btn').style.display = 'inline-block';
    }

    function fireConfetti() {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#bb86fc', '#03dac6'] });
    }

    /* --- LOGIC --- */
    const WINS_3X3 = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

    function checkWinNormal(boardArr, p) {
        return WINS_3X3.some(combo => combo.every(i => boardArr[i] === p));
    }

    function checkWin3D(b, p) {
        const checkLine = (sx,sy,sz, dx,dy,dz) => {
            for(let i=0; i<3; i++) {
                if (b[(sz+i*dz)*9 + (sy+i*dy)*3 + (sx+i*dx)] !== p) return false;
            }
            return true;
        };
        // 3D Logic: Rows, Cols, Pillars, Diags
        for(let z=0; z<3; z++) for(let y=0; y<3; y++) if(checkLine(0,y,z, 1,0,0)) return true;
        for(let z=0; z<3; z++) for(let x=0; x<3; x++) if(checkLine(x,0,z, 0,1,0)) return true;
        for(let y=0; y<3; y++) for(let x=0; x<3; x++) if(checkLine(x,y,0, 0,0,1)) return true;
        for(let z=0; z<3; z++) { if(checkLine(0,0,z, 1,1,0)) return true; if(checkLine(2,0,z, -1,1,0)) return true; }
        for(let y=0; y<3; y++) { if(checkLine(0,y,0, 1,0,1)) return true; if(checkLine(2,y,0, -1,0,1)) return true; }
        for(let x=0; x<3; x++) { if(checkLine(x,0,0, 0,1,1)) return true; if(checkLine(x,2,0, 0,-1,1)) return true; }
        if(checkLine(0,0,0, 1,1,1)) return true; if(checkLine(2,0,0, -1,1,1)) return true;
        if(checkLine(0,2,0, 1,-1,1)) return true; if(checkLine(2,2,0, -1,-1,1)) return true;
        return false;
    }

    function handleUltimateMove(idx, p) {
        const subGridIdx = Math.floor(idx / 9);
        const relativeIdx = idx % 9;
        const start = subGridIdx * 9;
        const subArr = state.board.slice(start, start+9);
        
        if (state.ultimateMacro[subGridIdx] === null && checkWinNormal(subArr, p)) {
            state.ultimateMacro[subGridIdx] = p;
            document.getElementById(`sub-${subGridIdx}`).classList.add(p === 'X' ? 'won-x' : 'won-o');
        }

        if (state.ultimateMacro[relativeIdx] !== null || isSubGridFull(relativeIdx)) {
            state.activeSubGrid = -1; 
        } else {
            state.activeSubGrid = relativeIdx;
        }
        
        // Helper to visual
        highlightActiveSubGrids();

        return checkWinNormal(state.ultimateMacro, p);
    }

    function highlightActiveSubGrids() {
        for(let i=0; i<9; i++) {
            const sub = document.getElementById(`sub-${i}`);
            sub.classList.remove('active-zone');
            if(state.ultimateMacro[i]) continue;
            if (state.activeSubGrid === -1 || state.activeSubGrid === i) {
                sub.classList.add('active-zone');
            }
        }
    }

    function isSubGridFull(subIdx) {
        for(let i=0; i<9; i++) if (state.board[subIdx*9 + i] === null) return false;
        return true;
    }

    function isDraw() { return state.board.every(c => c !== null); }

    /* --- BOT AI --- */
    function botMove() {
        let moves = [];
        for(let i=0; i<state.board.length; i++) if(isValidMove(i)) moves.push(i);
        if (moves.length === 0) return;

        const diff = state.difficulty;
        const rand = Math.random();
        let idx = -1;

        if (diff === 'easy') {
            idx = moves[Math.floor(Math.random() * moves.length)];
        } else if (diff === 'medium') {
            if (rand > 0.7) idx = moves[Math.floor(Math.random() * moves.length)];
            else idx = findBestMove(moves);
        } else {
            if (rand > 0.95) idx = moves[Math.floor(Math.random() * moves.length)];
            else idx = findBestMove(moves);
        }
        makeMove(idx, 'O');
    }

    function findBestMove(moves) {
        // Simple Minimax-lite
        for (let m of moves) { let temp = [...state.board]; temp[m] = 'O'; if (checkWinSim(temp, 'O')) return m; }
        for (let m of moves) { let temp = [...state.board]; temp[m] = 'X'; if (checkWinSim(temp, 'X')) return m; }
        if (state.variant === 'ultimate') {
             const preferred = moves.find(m => m % 9 === 4);
             if (preferred) return preferred;
        }
        if (state.variant === 'normal' && moves.includes(4)) return 4;
        if (state.variant === '3d' && moves.includes(13)) return 13;
        return moves[Math.floor(Math.random() * moves.length)];
    }

    function checkWinSim(b, p) {
        if (state.variant === 'normal') return checkWinNormal(b, p);
        if (state.variant === '3d') return checkWin3D(b, p);
        return false;
    }

    /* --- NETWORKING --- */
    function makeId(length) {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    function hostGame() {
        const name = document.getElementById('mp-name').value || "Host";
        state.p1Name = name;
        
        document.getElementById('mp-menu').style.display = 'none';
        document.getElementById('mp-host-area').style.display = 'block';

        const customId = makeId(9);
        state.peer = new Peer(customId);
        
        state.peer.on('open', (id) => { document.getElementById('host-code-display').innerText = id; });
        state.peer.on('error', () => { state.peer.destroy(); hostGame(); }); // Retry if taken

        state.peer.on('connection', (c) => {
            state.conn = c;
            setupConn();
            // Send config
            setTimeout(() => {
                state.conn.send({ type: 'start', variant: state.variant, hostName: name });
                state.myPlayer = 'X';
                initGame(state.variant);
            }, 1000);
        });
    }

    function joinGame() {
        const name = document.getElementById('mp-name').value || "Joiner";
        const code = document.getElementById('join-code').value.trim().toLowerCase();
        if (!code || code.length !== 9) return alert("Please enter the 9-character code.");
        
        state.p2Name = name; // You are P2
        document.getElementById('mp-menu').style.display = 'none';
        document.getElementById('mp-status').style.display = 'block';

        state.peer = new Peer(); 
        state.peer.on('open', () => {
            state.conn = state.peer.connect(code);
            setupConn();
        });
        state.peer.on('error', () => { alert("Connection Failed"); location.reload(); });
    }

    function setupConn() {
        state.conn.on('data', (data) => {
            if (data.type === 'start') {
                // Received from Host
                state.variant = data.variant;
                state.p1Name = data.hostName; 
                state.p2Name = document.getElementById('mp-name').value; // Confirm my name
                
                // Send back my name
                state.conn.send({ type: 'name-ack', name: state.p2Name });
                
                state.myPlayer = 'O'; 
                initGame(state.variant);
            }
            if (data.type === 'name-ack') {
                state.p2Name = data.name;
                updateScoreboard();
                updateTurnDisplay();
            }
            if (data.type === 'move') {
                makeMove(data.idx, state.myPlayer === 'X' ? 'O' : 'X');
            }
            if (data.type === 'restart') initGame(state.variant);
        });
        state.conn.on('close', () => alert("Opponent Disconnected"));
    }

    function triggerRestart() {
        initGame(state.variant);
        if (state.mode === 'human' && state.conn) state.conn.send({ type: 'restart' });
    }

</script>
</body>
</html>
