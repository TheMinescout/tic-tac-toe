<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#DD8566">
    <title>Terra Cotta Game Suite</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect x=%2210%22 y=%2210%22 width=%2244%22 height=%2244%22 rx=%228%22 fill=%22none%22 stroke=%22%23DD8566%22 stroke-width=%224%22/><circle cx=%2222%22 cy=%2222%22 r=%224%22 fill=%22%23474D4D%22/><circle cx=%2242%22 cy=%2222%22 r=%224%22 fill=%22%23474D4D%22/><path d=%22M20 40 Q32 50 44 40%22 stroke=%22%23474D4D%22 stroke-width=%224%22 fill=%22none%22 stroke-linecap=%22round%22/></svg>">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #FFFFFF; --text: #474D4D; --primary: #DD8566; --surface: #F5F5F5; --outline: #DBDCDF; --radius-btn: 12px; --radius-card: 16px; --shadow: 0 4px 12px rgba(0,0,0,0.08); }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; overflow-x: hidden; touch-action: pan-x pan-y; overscroll-behavior: none; }
        h1 { margin: 0 0 20px 0; letter-spacing: -0.5px; font-weight: 900; color: var(--text); text-transform: uppercase; }
        .sub-title { color: #999; margin-bottom: 30px; font-weight: 500; }
        .screen { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; animation: fadeIn 0.3s ease-out; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button { padding: 12px 24px; font-family: 'Roboto', sans-serif; font-size: 1rem; font-weight: 700; background-color: var(--bg); border: 2px solid var(--outline); color: var(--text); border-radius: var(--radius-btn); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow); margin: 5px; min-width: 120px; }
        button:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background-color: #c07055; color: white; }
        .btn-ai { background-color: #474D4D; color: white; border-color: #474D4D; font-size: 0.9rem; padding: 8px 16px; min-width: auto; }
        .back-btn { margin-top: 30px; background: transparent; border: none; color: #999; box-shadow: none; text-decoration: underline; font-weight: 400; }
        
        /* HUB */
        .hub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 500px; }
        .hub-card { background: var(--surface); padding: 25px 15px; border-radius: var(--radius-card); text-align: center; cursor: pointer; transition: 0.2s; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .hub-card:hover { border-color: var(--primary); background: #fff; transform: translateY(-3px); box-shadow: var(--shadow); }
        .hub-icon { font-size: 2rem; color: var(--primary); margin-bottom: 5px; }
        .hub-title { font-weight: 700; color: var(--text); font-size: 0.95rem; }

        /* GAMES */
        canvas { background: var(--surface); border-radius: var(--radius-card); box-shadow: inset 0 0 20px rgba(0,0,0,0.05); max-width: 100%; margin-top: 10px; touch-action: none; }
        .score-display { font-size: 2rem; font-weight: 900; color: var(--primary); margin: 10px 0; font-family: 'Roboto Mono', monospace; }
        .controls-row { display: flex; gap: 10px; margin-top: 20px; align-items: center; }

        /* MINESWEEPER */
        #ms-board { display: grid; gap: 2px; background: var(--outline); padding: 2px; border-radius: 8px; margin-top: 10px; user-select: none; touch-action: none; }
        .ms-cell { width: 30px; height: 30px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-family: 'Roboto Mono'; font-size: 1.2rem; }
        .ms-cell.revealed { background: #e5e5e5; color: var(--text); } .ms-cell.bomb { background: var(--text); color: white; } .ms-cell.flag { color: var(--primary); }

        /* 2048 */
        #grid-2048 { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 10px; background: var(--text); padding: 10px; border-radius: 12px; margin-top: 10px; width: 300px; aspect-ratio: 1; touch-action: none; }
        .tile-2048 { background: var(--surface); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: var(--text); width: 100%; height: 100%; }
        .tile-2048[data-val="2"] { background: #eee; } .tile-2048[data-val="4"] { background: #e0e0e0; } .tile-2048[data-val="8"] { background: #FFDBCF; }
        .tile-2048[data-val="16"] { background: #FFB8A5; color: white; } .tile-2048[data-val="32"] { background: #DD8566; color: white; }
        .tile-2048[data-val="64"] { background: #C06040; color: white; } .tile-2048[data-val="128"] { background: #A04020; color: white; font-size: 1.2rem; }

        /* TTT */
        #game-wrapper { position: relative; margin-top: 10px; width: 100%; display: flex; justify-content: center; }
        #win-line-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: visible; filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.3)); }
        .win-path { stroke: var(--primary); stroke-width: 16; stroke-linecap: round; fill: none; opacity: 0.9; stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: drawLine 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }
        .ttt-btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 15px 0; }
        .ttt-cell { display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; background: var(--bg); transition: 0.2s; border-radius: 4px; position: relative; z-index: 2; }
        .ttt-cell.x { color: var(--text); } .ttt-cell.o { color: var(--primary); }
        .ttt-cell.highlight { background-color: #FFDBCF !important; transition: background 0.5s; }
        #board-normal { display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 4px; background: var(--outline); padding: 4px; border-radius: 12px; }
        #board-normal .ttt-cell { font-size: 3rem; }
        #board-3d { perspective: 1000px; margin-top: 20px; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        .layer-3d { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; transform: rotateX(60deg) rotateZ(-45deg); margin-bottom: -40px; transition: transform 0.3s ease; background: rgba(255, 255, 255, 0.9); border: 1px solid var(--outline); padding: 6px; border-radius: 6px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); }
        .layer-3d:hover { transform: rotateX(60deg) rotateZ(-45deg) translateZ(15px); z-index: 10; border-color: var(--primary); }
        #board-3d .ttt-cell { width: 50px; height: 50px; font-size: 1.2rem; border: 1px solid #ccc; background: rgba(245,245,245,0.5); display: flex; align-items: center; justify-content: center; }
        #board-3d .ttt-cell span { transform: rotateZ(45deg); display:block; }
        #board-ultimate { display: grid; grid-template-columns: repeat(3, auto); gap: 6px; background: var(--text); padding: 6px; border-radius: 12px; }
        .sub-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: var(--outline); padding: 2px; position: relative; }
        .sub-grid.active-zone { background: #FFDBCF; }
        .sub-grid.won-x::after { content: "X"; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 80px; color: var(--text); opacity: 0.8; }
        .sub-grid.won-o::after { content: "O"; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 80px; color: var(--primary); opacity: 0.8; }
        .sub-grid.won-x .ttt-cell, .sub-grid.won-o .ttt-cell { opacity: 0.1; }
        #board-ultimate .ttt-cell { width: 32px; height: 32px; font-size: 1rem; background: var(--bg); }

        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 0.9rem; color: #777; justify-content: center;}
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }
        .code-box { background: var(--surface); padding: 10px; font-family: monospace; font-size: 1.5rem; border: 2px dashed var(--outline); color: var(--primary); margin: 10px; user-select: all; cursor: pointer; }
        input.mp-input { padding: 10px; border: 2px solid var(--outline); border-radius: 8px; text-align: center; font-size: 1.2rem; width: 200px; text-transform: uppercase; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal { background:white; padding:30px; border-radius:16px; max-width:400px; width:90%; text-align:center; }
        @media (max-width: 600px) { #board-normal { grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(3, 70px); } #board-normal .ttt-cell { font-size: 2.5rem; } }
    </style>
</head>
<body>

    <div id="screen-hub" class="screen active">
        <h1>Terra Cotta Suite</h1>
        <div class="sub-title">Select a Game</div>
        <div class="hub-grid">
            <div class="hub-card" onclick="Suite.loadGame('ttt')"><div class="hub-icon">âœ•</div><div class="hub-title">Tic-Tac-Toe</div></div>
            <div class="hub-card" onclick="Suite.loadGame('snake')"><div class="hub-icon">S</div><div class="hub-title">Snake</div></div>
            <div class="hub-card" onclick="Suite.loadGame('mines')"><div class="hub-icon">M</div><div class="hub-title">Minesweeper</div></div>
            <div class="hub-card" onclick="Suite.loadGame('dino')"><div class="hub-icon">D</div><div class="hub-title">Dino Run</div></div>
            <div class="hub-card" onclick="Suite.loadGame('pacman')"><div class="hub-icon">P</div><div class="hub-title">Pac-Man</div></div>
            <div class="hub-card" onclick="Suite.loadGame('breakout')"><div class="hub-icon">B</div><div class="hub-title">Breakout</div></div>
            <div class="hub-card" onclick="Suite.loadGame('2048')"><div class="hub-icon">2</div><div class="hub-title">2048</div></div>
            <div class="hub-card" onclick="Suite.loadGame('pong')"><div class="hub-icon">|</div><div class="hub-title">Pong</div></div>
        </div>
    </div>

    <div id="screen-snake" class="screen">
        <h1>Snake</h1><div class="score-display" id="snake-score">0</div>
        <canvas id="snake-canvas" width="300" height="300"></canvas>
        <div class="controls-row"><button class="btn-primary" onclick="SnakeGame.start()">Restart</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>
    
    <div id="screen-mines" class="screen">
        <h1>Minesweeper</h1><div class="btn-group"><button onclick="MinesGame.init('easy')">Easy</button><button onclick="MinesGame.init('hard')">Hard</button></div>
        <div id="ms-board"></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>
    
    <div id="screen-dino" class="screen">
        <h1>Dino Run</h1><div class="score-display" id="dino-score">0</div>
        <canvas id="dino-canvas" width="600" height="200"></canvas>
        <div class="controls-row"><button id="dino-start-btn" class="btn-primary" onclick="DinoGame.start()">Start Run</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>
    
    <div id="screen-pacman" class="screen">
        <h1>Pac-Man Lite</h1><div class="score-display" id="pac-score">0</div>
        <canvas id="pac-canvas" width="300" height="300"></canvas>
        <div class="controls-row"><button class="btn-primary" onclick="PacGame.start()">Restart</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>

    <div id="screen-breakout" class="screen">
        <h1>Breakout</h1><div class="score-display" id="breakout-score">0</div>
        <canvas id="breakout-canvas" width="300" height="400"></canvas>
        <div class="controls-row"><button class="btn-primary" onclick="BreakoutGame.start()">Restart</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>

    <div id="screen-2048" class="screen">
        <h1>2048</h1><div class="score-display" id="2048-score">0</div>
        <div id="grid-2048"></div>
        <div class="controls-row"><button class="btn-primary" onclick="Game2048.start()">Restart</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>

    <div id="screen-pong" class="screen">
        <h1>Pong</h1><div class="score-display" id="pong-score">0 - 0</div>
        <canvas id="pong-canvas" width="300" height="400"></canvas>
        <div class="controls-row"><button class="btn-primary" onclick="PongGame.start()">Restart</button><button class="btn-ai" onclick="Suite.toggleAI()">ðŸ¤– Auto-Play</button></div>
        <button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button>
    </div>

    <div id="screen-ttt" class="screen">
        <h1>Tic-Tac-Toe</h1>
        <div id="ttt-menu"><div class="btn-group"><button onclick="TTT.setup('local')">Pass & Play</button><button onclick="TTT.setup('bot-diff')">vs Bot</button><button onclick="TTT.setup('mp')">Multiplayer</button></div><div class="toggle-wrapper"><label class="switch"><input type="checkbox" id="anim-toggle" checked><span class="slider"></span></label><span>Cinematic Win Effects</span></div><button class="back-btn" onclick="Suite.goHome()">Exit to Hub</button></div>
        <div id="ttt-bot-diff" style="display:none; text-align:center;"><h3>Bot Difficulty</h3><div class="btn-group"><button onclick="TTT.setDifficulty('easy')">Easy</button><button onclick="TTT.setDifficulty('medium')">Medium</button><button onclick="TTT.setDifficulty('hard')">Hard</button></div><button class="back-btn" onclick="TTT.showMenu()">Back</button></div>
        <div id="ttt-mp-setup" style="display:none; text-align:center;"><h3>Multiplayer</h3><input type="text" id="mp-name" class="mp-input" placeholder="Your Name" value="Player"><div style="margin:20px 0;"><button onclick="TTT.host()">Host Game</button><p style="color:#999; margin:10px;">- OR -</p><input type="text" id="join-code" class="mp-input" placeholder="9-CHAR CODE" maxlength="9"><br><br><button onclick="TTT.join()">Join Game</button></div><button class="back-btn" onclick="TTT.showMenu()">Back</button></div>
        <div id="ttt-host-wait" style="display:none; text-align:center;"><h3>Waiting...</h3><div id="host-code" class="code-box" onclick="TTT.copyLink()">Generating...</div><div style="color:#999; font-size:0.8rem">Tap to Copy Link</div><div id="host-status" style="margin-top:20px; color:var(--primary)">Waiting for player...</div><button class="back-btn" onclick="TTT.showMenu()">Cancel</button></div>
        <div id="ttt-variant" style="display:none; text-align:center;"><h3>Select Mode</h3><div class="ttt-btn-group"><button onclick="TTT.startGame('normal')">3x3</button><button onclick="TTT.startGame('3d')">3D</button><button onclick="TTT.startGame('ultimate')">Ultimate</button></div><button class="back-btn" onclick="TTT.showMenu()">Back</button></div>
        <div id="ttt-game" style="display:none; width:100%; display:flex; flex-direction:column; align-items:center;"><div id="ttt-scoreboard" style="display:flex; gap:20px; margin-bottom:15px; font-weight:bold;"><span id="p1-score">P1: 0</span><span id="p2-score">P2: 0</span></div><div id="ttt-turn" style="color:var(--primary); font-weight:bold; margin-bottom:15px;">Turn: X</div><div id="game-wrapper"><svg id="win-line-svg"></svg><div id="ttt-board-container"></div></div><button id="ttt-restart" class="btn-primary" style="margin-top:20px; display:none;" onclick="TTT.restart()">Next Round</button><button class="back-btn" onclick="TTT.showMenu()">End Game</button></div>
    </div>

    <div class="modal-overlay" id="rules-modal" onclick="this.style.display='none'"><div class="modal" onclick="event.stopPropagation()"><h3 id="modal-title">Game Over</h3><p id="modal-msg">Score: 100</p><button class="btn-primary" onclick="document.getElementById('rules-modal').style.display='none'">Close</button></div></div>
    <div id="toast" style="visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);">Link Copied!</div>

<script>
    // --- GLOBAL MANAGER ---
    const Suite = {
        activeGame: null, aiMode: false,
        goHome: () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-hub').classList.add('active');
            if(Suite.activeGame && Suite.activeGame.stop) Suite.activeGame.stop();
            Suite.activeGame = null; Suite.aiMode = false;
            if(TTT.peer) { TTT.peer.destroy(); TTT.peer = null; }
        },
        loadGame: (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            Suite.aiMode = false;
            if(id === 'snake') { Suite.activeGame = SnakeGame; SnakeGame.start(); }
            if(id === 'dino') { Suite.activeGame = DinoGame; DinoGame.start(); }
            if(id === 'pacman') { Suite.activeGame = PacGame; PacGame.start(); }
            if(id === 'breakout') { Suite.activeGame = BreakoutGame; BreakoutGame.start(); }
            if(id === '2048') { Suite.activeGame = Game2048; Game2048.start(); }
            if(id === 'pong') { Suite.activeGame = PongGame; PongGame.start(); }
            if(id === 'ttt') { Suite.activeGame = null; TTT.showMenu(); }
            if(id === 'mines') { Suite.activeGame = null; MinesGame.init('easy'); }
        },
        toggleAI: () => { Suite.aiMode = !Suite.aiMode; },
        showModal: (title, msg) => { document.getElementById('modal-title').innerText = title; document.getElementById('modal-msg').innerHTML = msg; document.getElementById('rules-modal').style.display = 'flex'; }
    };

    // Global Input Handler
    window.addEventListener("keydown", function(e) {
        if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1 && !document.getElementById('screen-hub').classList.contains('active')) e.preventDefault();
        if(Suite.activeGame && Suite.activeGame.handleInput) Suite.activeGame.handleInput(e);
    });

    // --- GAME MODULES ---
    
    // SNAKE
    const SnakeGame = {
        canvas: document.getElementById('snake-canvas'), ctx: document.getElementById('snake-canvas').getContext('2d'), grid: 15, snake: {}, apple: {}, score: 0, running: false, interval: null,
        start: function() { this.snake={x:150,y:150,dx:15,dy:0,cells:[],maxCells:4}; this.apple={x:60,y:60}; this.score=0; this.running=true; document.getElementById('snake-score').innerText=0; if(this.interval)clearInterval(this.interval); this.interval=setInterval(()=>this.loop(),100); this.setupTouch(); },
        stop: function() { this.running=false; clearInterval(this.interval); },
        loop: function() {
            if(!this.running)return;
            if(Suite.aiMode) this.aiMove();
            this.ctx.clearRect(0,0,300,300);
            this.snake.x+=this.snake.dx; this.snake.y+=this.snake.dy;
            if(this.snake.x<0)this.snake.x=285; else if(this.snake.x>=300)this.snake.x=0; if(this.snake.y<0)this.snake.y=285; else if(this.snake.y>=300)this.snake.y=0;
            this.snake.cells.unshift({x:this.snake.x,y:this.snake.y}); if(this.snake.cells.length>this.snake.maxCells)this.snake.cells.pop();
            this.ctx.fillStyle='#DD8566'; this.ctx.fillRect(this.apple.x,this.apple.y,14,14); this.ctx.fillStyle='#474D4D';
            this.snake.cells.forEach((c,i)=>{ this.ctx.fillRect(c.x,c.y,14,14); if(i>0&&c.x===this.snake.cells[0].x&&c.y===this.snake.cells[0].y) {this.stop(); Suite.showModal("Game Over", "Score: "+this.score);} });
            if(this.snake.cells[0].x===this.apple.x&&this.snake.cells[0].y===this.apple.y){ this.snake.maxCells++; this.score+=10; document.getElementById('snake-score').innerText=this.score; this.apple.x=Math.floor(Math.random()*20)*15; this.apple.y=Math.floor(Math.random()*20)*15; }
        },
        handleInput: function(e){ if(e.which===37&&this.snake.dx===0){this.snake.dx=-15;this.snake.dy=0;} else if(e.which===38&&this.snake.dy===0){this.snake.dy=-15;this.snake.dx=0;} else if(e.which===39&&this.snake.dx===0){this.snake.dx=15;this.snake.dy=0;} else if(e.which===40&&this.snake.dy===0){this.snake.dy=15;this.snake.dx=0;} },
        aiMove: function() {
            const h = this.snake.cells[0]; const dx = this.apple.x - h.x; const dy = this.apple.y - h.y;
            if(Math.abs(dx) > Math.abs(dy)) { if(dx>0 && this.snake.dx===0) {this.snake.dx=15;this.snake.dy=0;} else if(dx<0 && this.snake.dx===0) {this.snake.dx=-15;this.snake.dy=0;} else {if(dy>0) {this.snake.dy=15;this.snake.dx=0;} else {this.snake.dy=-15;this.snake.dx=0;}} }
            else { if(dy>0 && this.snake.dy===0) {this.snake.dy=15;this.snake.dx=0;} else if(dy<0 && this.snake.dy===0) {this.snake.dy=-15;this.snake.dx=0;} else {if(dx>0) {this.snake.dx=15;this.snake.dy=0;} else {this.snake.dx=-15;this.snake.dy=0;}} }
        },
        setupTouch: function(){let tx=0,ty=0; this.canvas.ontouchstart=e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY}; this.canvas.ontouchmove=e=>{e.preventDefault();}; this.canvas.ontouchend=e=>{const dx=e.changedTouches[0].clientX-tx, dy=e.changedTouches[0].clientY-ty; if(Math.abs(dx)>Math.abs(dy)){if(dx>0&&this.snake.dx===0){this.snake.dx=15;this.snake.dy=0;}else if(this.snake.dx===0){this.snake.dx=-15;this.snake.dy=0;}}else{if(dy>0&&this.snake.dy===0){this.snake.dy=15;this.snake.dx=0;}else if(this.snake.dy===0){this.snake.dy=-15;this.snake.dx=0;}}};}
    };

    // DINO
    const DinoGame = {
        canvas: document.getElementById('dino-canvas'), ctx: document.getElementById('dino-canvas').getContext('2d'), running: false, dino: {x:50,y:150,w:30,h:30,dy:0,grounded:true}, obstacles: [], frame: 0, score: 0,
        start: function() { this.running=true; this.score=0; this.frame=0; this.obstacles=[]; this.dino.y=150; this.dino.dy=0; document.getElementById('dino-start-btn').style.display='none'; if(this.interval)clearInterval(this.interval); this.interval=setInterval(()=>this.update(),20); this.canvas.ontouchstart=(e)=>{e.preventDefault();this.jump()}; },
        stop: function() { this.running=false; clearInterval(this.interval); document.getElementById('dino-start-btn').style.display='inline-block'; document.getElementById('dino-start-btn').innerText="Try Again"; },
        jump: function() { if(this.dino.grounded) { this.dino.dy=-12; this.dino.grounded=false; } },
        handleInput: function(e) { if(e.code==='Space') this.jump(); },
        update: function() {
            this.ctx.clearRect(0,0,600,200);
            if(Suite.aiMode) { const obs = this.obstacles.find(o => o.x > this.dino.x); if(obs && obs.x - this.dino.x < 100) this.jump(); }
            this.dino.dy+=0.8; this.dino.y+=this.dino.dy; if(this.dino.y>150){this.dino.y=150;this.dino.dy=0;this.dino.grounded=true;}
            this.ctx.fillStyle='#DD8566'; this.ctx.fillRect(this.dino.x, this.dino.y, this.dino.w, this.dino.h);
            this.ctx.beginPath(); this.ctx.moveTo(0,180); this.ctx.lineTo(600,180); this.ctx.strokeStyle='#474D4D'; this.ctx.stroke();
            this.frame++; if(this.frame%90===0) this.obstacles.push({x:600,w:20,h:30+Math.random()*20});
            this.ctx.fillStyle='#474D4D';
            this.obstacles.forEach(o=>{ o.x-=6; this.ctx.fillRect(o.x,180-o.h,o.w,o.h); if(this.dino.x<o.x+o.w && this.dino.x+this.dino.w>o.x && this.dino.y<180 && this.dino.y+this.dino.h>180-o.h) {this.stop(); Suite.showModal("Crashed!", "Score: "+Math.floor(this.score));} });
            this.score+=0.1; document.getElementById('dino-score').innerText=Math.floor(this.score);
        },
        draw: function() { this.ctx.clearRect(0,0,600,200); this.ctx.fillStyle='#DD8566'; this.ctx.fillRect(50,150,30,30); this.ctx.beginPath(); this.ctx.moveTo(0,180); this.ctx.lineTo(600,180); this.ctx.strokeStyle='#474D4D'; this.ctx.stroke(); }
    };

    // PACMAN
    const PacGame = {
        canvas: document.getElementById('pac-canvas'), ctx: document.getElementById('pac-canvas').getContext('2d'), grid: 16, pac: {}, dir: {}, nextDir: {}, ghosts: [], map: [], score: 0, running: false, interval: null, mouthOpen: true,
        masterMap: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],[1,1,1,1,0,1,2,2,2,2,2,2,2,1,0,1,1,1,1],[1,0,0,0,0,1,2,1,1,2,1,1,2,1,0,0,0,0,1],[1,1,1,1,0,1,2,1,2,2,2,1,2,1,0,1,1,1,1],[1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        start: function() {
            this.pac={x:9,y:14}; this.dir={x:0,y:0}; this.nextDir={x:0,y:0}; this.score=0; this.running=true;
            document.getElementById('pac-score').innerText = '0';
            this.map = JSON.parse(JSON.stringify(this.masterMap)); // Fix Map Reset
            this.ghosts = [{x:8,y:8,c:'#FF0000',t:0,d:{x:0,y:0}}, {x:9,y:8,c:'#FFB8FF',t:1,d:{x:0,y:0}}, {x:10,y:8,c:'#00FFFF',t:2,d:{x:0,y:0}}];
            if(this.interval) clearInterval(this.interval); this.interval = setInterval(() => this.update(), 120);
            this.setupTouch();
        },
        stop: function() { this.running = false; clearInterval(this.interval); },
        handleInput: function(e) { if(e.key==='ArrowUp')this.nextDir={x:0,y:-1}; else if(e.key==='ArrowDown')this.nextDir={x:0,y:1}; else if(e.key==='ArrowLeft')this.nextDir={x:-1,y:0}; else if(e.key==='ArrowRight')this.nextDir={x:1,y:0}; },
        isValid: function(x,y) { return y>=0 && y<this.map.length && x>=0 && x<this.map[0].length && this.map[y][x]!==1; },
        update: function() {
            if(!this.running) return;
            if(Suite.aiMode) { // Simple AI: Target dots, avoid ghosts
                const dirs = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
                let bestDir = this.dir; let minDist = Infinity;
                dirs.forEach(d => {
                    if(this.isValid(this.pac.x+d.x, this.pac.y+d.y)) {
                        // Very simple: dist to center of map (keeps moving) + randomness
                        let dist = Math.random() * 10;
                        if(dist < minDist) { minDist = dist; bestDir = d; }
                    }
                });
                this.nextDir = bestDir;
            }
            if(this.nextDir.x||this.nextDir.y) { if(this.isValid(this.pac.x+this.nextDir.x, this.pac.y+this.nextDir.y)) { this.dir=this.nextDir; this.nextDir={x:0,y:0}; } }
            let nx=this.pac.x+this.dir.x; let ny=this.pac.y+this.dir.y;
            if(nx<0) nx=this.map[0].length-1; if(nx>=this.map[0].length) nx=0;
            if(this.isValid(nx,ny)) { this.pac.x=nx; this.pac.y=ny; this.mouthOpen=!this.mouthOpen; }
            if(this.map[this.pac.y][this.pac.x]===0) { this.map[this.pac.y][this.pac.x]=2; this.score+=10; document.getElementById('pac-score').innerText=this.score; if(!this.map.some(r=>r.includes(0))) this.end(true); }
            this.ghosts.forEach(g=>this.moveGhost(g));
            this.ghosts.forEach(g=>{ if(g.x===this.pac.x && g.y===this.pac.y) this.end(false); });
            this.draw();
        },
        moveGhost: function(g) {
            const dirs=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
            let valid = dirs.filter(d => this.isValid(g.x+d.x, g.y+d.y) && !(d.x===-g.d.x && d.y===-g.d.y));
            if(valid.length===0) valid = dirs.filter(d => this.isValid(g.x+d.x, g.y+d.y));
            if(valid.length>0) {
                let target = {x:this.pac.x, y:this.pac.y};
                valid.sort((a,b) => Math.hypot((g.x+a.x)-target.x, (g.y+a.y)-target.y) - Math.hypot((g.x+b.x)-target.x, (g.y+b.y)-target.y));
                g.d = (Math.random() > 0.8 && valid.length > 1) ? valid[Math.floor(Math.random()*valid.length)] : valid[0];
                g.x += g.d.x; g.y += g.d.y;
            }
        },
        draw: function() {
            this.ctx.fillStyle='#000'; this.ctx.fillRect(0,0,300,300);
            const cs = 300/this.map[0].length;
            for(let y=0;y<this.map.length;y++) for(let x=0;x<this.map[y].length;x++) {
                if(this.map[y][x]===1) { this.ctx.fillStyle='#1919A6'; this.ctx.fillRect(x*cs,y*cs,cs,cs); }
                else if(this.map[y][x]===0) { this.ctx.fillStyle='#FFB8AE'; this.ctx.beginPath(); this.ctx.arc(x*cs+cs/2,y*cs+cs/2,2,0,6.28); this.ctx.fill(); }
            }
            this.ctx.fillStyle='#FFFF00'; this.ctx.beginPath(); this.ctx.arc(this.pac.x*cs+cs/2, this.pac.y*cs+cs/2, cs/2-1, this.mouthOpen?0.2*Math.PI:0, this.mouthOpen?1.8*Math.PI:2*Math.PI); this.ctx.fill();
            this.ghosts.forEach(g => { this.ctx.fillStyle=g.c; this.ctx.fillRect(g.x*cs+2, g.y*cs+2, cs-4, cs-4); });
        },
        end: function(w) { this.stop(); Suite.showModal(w?"YOU WON!":"GAME OVER", `Score: ${this.score}`); },
        setupTouch: function(){let tx=0,ty=0; this.canvas.ontouchstart=e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY}; this.canvas.ontouchmove=e=>{e.preventDefault();}; this.canvas.ontouchend=e=>{const dx=e.changedTouches[0].clientX-tx, dy=e.changedTouches[0].clientY-ty; if(Math.abs(dx)>Math.abs(dy))this.nextDir=dx>0?{x:1,y:0}:{x:-1,y:0}; else this.nextDir=dy>0?{x:0,y:1}:{x:0,y:-1};};}
    };

    // BREAKOUT
    const BreakoutGame = {
        c: document.getElementById('breakout-canvas'), ctx: document.getElementById('breakout-canvas').getContext('2d'), ball: {}, paddle: {}, bricks: [], running:false, score:0, interval:null,
        start: function() {
            this.ball={x:150, y:200, dx:3, dy:-3, r:5}; this.paddle={x:125, w:60, h:10}; this.score=0; this.running=true; document.getElementById('breakout-score').innerText='0'; this.bricks=[]; for(let c=0; c<5; c++) for(let r=0; r<4; r++) this.bricks.push({x:c*55+15, y:r*20+30, status:1});
            if(this.interval) clearInterval(this.interval); this.interval=setInterval(()=>this.update(), 16);
            this.c.onmousemove = e => { const r = this.c.getBoundingClientRect(); this.paddle.x = e.clientX - r.left - this.paddle.w/2; };
            this.c.ontouchmove = e => { e.preventDefault(); const r = this.c.getBoundingClientRect(); this.paddle.x = e.touches[0].clientX - r.left - this.paddle.w/2; };
        },
        stop: function() { this.running=false; clearInterval(this.interval); },
        update: function() {
            if(!this.running) return; this.ctx.clearRect(0,0,300,400);
            if(Suite.aiMode) this.paddle.x = this.ball.x - this.paddle.w/2;
            this.ball.x+=this.ball.dx; this.ball.y+=this.ball.dy;
            if(this.ball.x<0 || this.ball.x>300) this.ball.dx=-this.ball.dx; if(this.ball.y<0) this.ball.dy=-this.ball.dy;
            else if(this.ball.y>400) { this.stop(); Suite.showModal("Game Over", `Score: ${this.score}`); }
            if(this.ball.y>380 && this.ball.x>this.paddle.x && this.ball.x<this.paddle.x+this.paddle.w) this.ball.dy=-Math.abs(this.ball.dy);
            this.bricks.forEach(b=>{ if(b.status===1 && this.ball.x>b.x && this.ball.x<b.x+50 && this.ball.y>b.y && this.ball.y<b.y+15) { this.ball.dy=-this.ball.dy; b.status=0; this.score+=10; document.getElementById('breakout-score').innerText=this.score; } });
            this.bricks.forEach(b=>{ if(b.status===1) { this.ctx.fillStyle='#DD8566'; this.ctx.fillRect(b.x,b.y,50,15); } });
            this.ctx.fillStyle='#474D4D'; this.ctx.beginPath(); this.ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, 6.28); this.ctx.fill();
            this.ctx.fillRect(this.paddle.x, 380, this.paddle.w, this.paddle.h);
        }
    };

    // 2048 - FIXED
    const Game2048 = {
        grid: [], score: 0,
        start: function() { this.grid = Array(16).fill(0); this.score=0; this.addNew(); this.addNew(); this.draw(); 
            let tsX=0, tsY=0; const el=document.getElementById('grid-2048');
            el.ontouchstart=e=>{tsX=e.touches[0].clientX;tsY=e.touches[0].clientY}; el.ontouchmove=e=>{e.preventDefault()};
            el.ontouchend=e=>{const dx=e.changedTouches[0].clientX-tsX, dy=e.changedTouches[0].clientY-tsY; if(Math.abs(dx)>Math.abs(dy)) this.move(dx>0?1:3); else this.move(dy>0?2:0);};
        },
        addNew: function() { let em = this.grid.map((v,i)=>v===0?i:null).filter(v=>v!==null); if(em.length) this.grid[em[Math.floor(Math.random()*em.length)]] = Math.random()>0.9?4:2; },
        draw: function() { 
            const el = document.getElementById('grid-2048'); el.innerHTML=''; document.getElementById('2048-score').innerText = this.score;
            this.grid.forEach(v => { const t = document.createElement('div'); t.className='tile-2048'; if(v>0) { t.dataset.val=v; t.innerText=v; } el.appendChild(t); });
        },
        move: function(dir) {
            if(Suite.aiMode) dir = Math.floor(Math.random()*4); // Random AI for 2048
            let changed = false;
            const rotate = (n) => { const ng = Array(16).fill(0); for(let i=0; i<4; i++) for(let j=0; j<4; j++) if(n===1) ng[j*4+(3-i)] = this.grid[i*4+j]; else ng[i*4+j] = this.grid[i*4+j]; this.grid = ng; };
            for(let i=0; i<dir; i++) rotate(1);
            for(let i=0; i<4; i++) {
                let row = this.grid.slice(i*4, i*4+4).filter(v=>v);
                for(let j=0; j<row.length-1; j++) if(row[j]===row[j+1]) { row[j]*=2; this.score+=row[j]; row[j+1]=0; }
                row = row.filter(v=>v); while(row.length<4) row.push(0);
                for(let j=0; j<4; j++) if(this.grid[i*4+j] !== row[j]) { this.grid[i*4+j] = row[j]; changed=true; }
            }
            for(let i=0; i<(4-dir)%4; i++) rotate(1);
            if(changed) { this.addNew(); this.draw(); } else if(Suite.aiMode) this.move((dir+1)%4);
        },
        handleInput: function(e) {
            // Mapping: 0=Left, 1=Down, 2=Right, 3=Up (to match rotate logic)
            // Correction: Standard rotate logic usually Left based.
            // Let's force standard: 0=Left, 1=Down, 2=Right, 3=Up
            if(e.key==='ArrowLeft') this.move(0); else if(e.key==='ArrowDown') this.move(1); else if(e.key==='ArrowRight') this.move(2); else if(e.key==='ArrowUp') this.move(3);
        }
    };

    // PONG
    const PongGame = {
        c: document.getElementById('pong-canvas'), ctx: document.getElementById('pong-canvas').getContext('2d'), ball: {}, p1: {}, p2: {}, score: [0,0], running: false, interval: null,
        start: function() {
            this.score=[0,0]; this.running=true; document.getElementById('pong-score').innerText="0 - 0"; this.resetBall();
            this.p1={x:130, y:380, w:40, h:10}; this.p2={x:130, y:10, w:40, h:10};
            if(this.interval) clearInterval(this.interval); this.interval=setInterval(()=>this.update(), 16);
            this.c.onmousemove = e => { const r = this.c.getBoundingClientRect(); this.p1.x = e.clientX - r.left - 20; };
            this.c.ontouchmove = e => { e.preventDefault(); const r = this.c.getBoundingClientRect(); this.p1.x = e.touches[0].clientX - r.left - 20; };
        },
        stop: function() { this.running=false; clearInterval(this.interval); },
        resetBall: function() { this.ball={x:150, y:200, dx:(Math.random()>0.5?3:-3), dy:(Math.random()>0.5?3:-3), r:5}; },
        update: function() {
            if(!this.running) return; this.ctx.clearRect(0,0,300,400);
            if(Suite.aiMode) this.p1.x = this.ball.x - 20;
            this.ball.x+=this.ball.dx; this.ball.y+=this.ball.dy;
            if(this.ball.x<0 || this.ball.x>300) this.ball.dx=-this.ball.dx;
            if(this.p2.x+20 < this.ball.x) this.p2.x += 3; else this.p2.x -= 3;
            if(this.ball.y>370 && this.ball.x>this.p1.x && this.ball.x<this.p1.x+40) this.ball.dy = -Math.abs(this.ball.dy);
            if(this.ball.y<30 && this.ball.x>this.p2.x && this.ball.x<this.p2.x+40) this.ball.dy = Math.abs(this.ball.dy);
            if(this.ball.y<0) { this.score[0]++; this.resetBall(); } if(this.ball.y>400) { this.score[1]++; this.resetBall(); }
            document.getElementById('pong-score').innerText = `${this.score[0]} - ${this.score[1]}`;
            if(this.score[0]>=5 || this.score[1]>=5) { this.stop(); Suite.showModal(this.score[0]>this.score[1]?"You Won!":"You Lost!", ""); }
            this.ctx.fillStyle='#DD8566'; this.ctx.fillRect(this.p1.x, this.p1.y, this.p1.w, this.p1.h);
            this.ctx.fillStyle='#474D4D'; this.ctx.fillRect(this.p2.x, this.p2.y, this.p2.w, this.p2.h);
            this.ctx.beginPath(); this.ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, 6.28); this.ctx.fill();
        }
    };

    // MINESWEEPER (Fixed Init)
    const MinesGame = {
        grid: [], rows: 10, cols: 10, mines: 15, gameOver: false,
        init: function(diff) {
            this.rows = diff==='hard'?14:10; this.cols = diff==='hard'?14:10; this.mines = diff==='hard'?35:12; this.gameOver = false;
            const board = document.getElementById('ms-board'); board.style.gridTemplateColumns = `repeat(${this.cols}, 30px)`; board.innerHTML = '';
            this.grid = [];
            for(let r=0; r<this.rows; r++) {
                let row = [];
                for(let c=0; c<this.cols; c++) {
                    const el = document.createElement('div'); el.className = 'ms-cell';
                    el.onclick = () => this.click(r,c); el.oncontextmenu = (e) => { e.preventDefault(); this.flag(r,c); };
                    let pressTimer; el.ontouchstart = () => { pressTimer = setTimeout(() => this.flag(r,c), 500); }; el.ontouchend = () => clearTimeout(pressTimer);
                    board.appendChild(el); row.push({el: el, mine: false, revealed: false, flagged: false, neighbors: 0});
                }
                this.grid.push(row);
            }
            let minesPlaced = 0;
            while(minesPlaced < this.mines) { let r = Math.floor(Math.random()*this.rows); let c = Math.floor(Math.random()*this.cols); if(!this.grid[r][c].mine) { this.grid[r][c].mine = true; minesPlaced++; } }
            for(let r=0; r<this.rows; r++) for(let c=0; c<this.cols; c++) {
                if(this.grid[r][c].mine) continue;
                let count = 0;
                for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) if(r+i>=0 && r+i<this.rows && c+j>=0 && c+j<this.cols && this.grid[r+i][c+j].mine) count++;
                this.grid[r][c].neighbors = count;
            }
        },
        click: function(r,c) {
            if(this.gameOver || this.grid[r][c].flagged || this.grid[r][c].revealed) return;
            const cell = this.grid[r][c]; cell.revealed = true; cell.el.classList.add('revealed');
            if(cell.mine) { cell.el.classList.add('bomb'); cell.el.innerText = 'ðŸ’£'; this.gameOver = true; setTimeout(() => Suite.showModal("BOOM", "You hit a mine!"), 200); }
            else {
                if(cell.neighbors > 0) { cell.el.innerText = cell.neighbors; cell.el.style.color = ['#DD8566','#474D4D','#d35400','#2c3e50'][(cell.neighbors-1)%4]; }
                else { for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) if(r+i>=0 && r+i<this.rows && c+j>=0 && c+j<this.cols) this.click(r+i, c+j); }
            }
        },
        flag: function(r,c) { if(this.gameOver || this.grid[r][c].revealed) return; const cell = this.grid[r][c]; cell.flagged = !cell.flagged; cell.el.innerText = cell.flagged ? 'ðŸš©' : ''; cell.el.classList.toggle('flag'); }
    };

    // TIC TAC TOE (Fixed 3D Logic)
    const TTT = {
        mode: null, variant: null, peer: null, conn: null, difficulty: 'medium',
        board: [], turn: 'X', myPlayer: 'X', active: false, ultMacro: [], activeSubGrid: -1, scores: {p1:0, p2:0, draw:0}, animationsEnabled: true, nextStarter: 'X', currentStarter: 'X',
        // Hardcoded 49 winning lines for 3D 3x3x3
        winLines3D: [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6],[9,10,11],[12,13,14],[15,16,17],[9,12,15],[10,13,16],[11,14,17],[9,13,17],[11,13,15],[18,19,20],[21,22,23],[24,25,26],[18,21,24],[19,22,25],[20,23,26],[18,22,26],[20,22,24],[0,9,18],[1,10,19],[2,11,20],[3,12,21],[4,13,22],[5,14,23],[6,15,24],[7,16,25],[8,17,26],[0,12,24],[6,12,18],[1,13,25],[7,13,19],[2,14,26],[8,14,20],[0,10,20],[2,10,18],[3,13,23],[5,13,21],[6,16,26],[8,16,24],[0,13,26],[2,13,24],[6,13,20],[8,13,18]],
        
        showMenu: () => { document.getElementById('ttt-menu').style.display='block'; ['ttt-mp-setup','ttt-host-wait','ttt-variant','ttt-game','ttt-bot-diff'].forEach(id=>document.getElementById(id).style.display='none'); },
        setup: (mode) => { TTT.mode = mode; document.getElementById('ttt-menu').style.display='none'; if(mode==='mp') document.getElementById('ttt-mp-setup').style.display='block'; else if(mode==='bot-diff') document.getElementById('ttt-bot-diff').style.display='block'; else { TTT.mode='local'; document.getElementById('ttt-variant').style.display='block'; } },
        setDifficulty: (diff) => { TTT.difficulty=diff; TTT.mode='bot'; document.getElementById('ttt-bot-diff').style.display='none'; document.getElementById('ttt-variant').style.display='block'; },
        startGame: (v) => { TTT.variant=v; document.getElementById('ttt-variant').style.display='none'; document.getElementById('ttt-game').style.display='flex'; TTT.initBoard(); },
        initBoard: () => {
            TTT.active=true; TTT.turn=TTT.nextStarter; TTT.currentStarter=TTT.nextStarter; TTT.ultMacro=Array(9).fill(null); TTT.activeSubGrid=-1;
            document.getElementById('win-line-svg').innerHTML=''; const b3=document.getElementById('board-3d'); if(b3)b3.classList.remove('stacked');
            document.getElementById('ttt-restart').style.display='none'; document.getElementById('ttt-turn').innerText=`Turn: ${TTT.turn}`;
            const con=document.getElementById('ttt-board-container'); con.innerHTML='';
            if(TTT.variant==='normal') { TTT.board=Array(9).fill(null); const g=document.createElement('div'); g.id='board-normal'; for(let i=0;i<9;i++)g.appendChild(TTT.cell(i)); con.appendChild(g); }
            if(TTT.variant==='3d') { TTT.board=Array(27).fill(null); const w=document.createElement('div'); w.id='board-3d'; for(let z=0;z<3;z++){ const l=document.createElement('div'); l.className='layer-3d'; for(let i=0;i<9;i++)l.appendChild(TTT.cell(z*9+i)); w.appendChild(l); } con.appendChild(w); }
            if(TTT.variant==='ultimate') { TTT.board=Array(81).fill(null); const g=document.createElement('div'); g.id='board-ultimate'; for(let i=0;i<9;i++){ const s=document.createElement('div'); s.className='sub-grid active-zone'; s.id=`sub-${i}`; for(let j=0;j<9;j++)s.appendChild(TTT.cell(i*9+j)); g.appendChild(s); } con.appendChild(g); }
            if(TTT.mode==='bot' && TTT.turn==='O') setTimeout(TTT.botMove, 800);
        },
        cell: (idx) => { const c=document.createElement('div'); c.className='ttt-cell'; c.dataset.idx=idx; const s=document.createElement('span'); c.appendChild(s); c.onclick=()=>TTT.click(idx); return c; },
        click: (idx) => { if(!TTT.active || (TTT.mode!=='local' && TTT.turn!==TTT.myPlayer)) return; if(TTT.board[idx]) return; if(TTT.variant==='ultimate' && (TTT.activeSubGrid!==-1 && Math.floor(idx/9)!==TTT.activeSubGrid || TTT.ultMacro[Math.floor(idx/9)])) return; TTT.move(idx, TTT.turn); if(TTT.mode==='mp' && TTT.conn) TTT.conn.send({type:'move', idx:idx}); if(TTT.mode==='bot' && TTT.active) setTimeout(TTT.botMove, 500); },
        move: (idx, p) => {
            TTT.board[idx] = p; let el;
            if(TTT.variant==='normal') el=document.querySelector(`#board-normal .ttt-cell[data-idx='${idx}']`);
            else if(TTT.variant==='3d') el=document.querySelector(`.layer-3d .ttt-cell[data-idx='${idx}']`);
            else el=document.querySelector(`#board-ultimate .ttt-cell[data-idx='${idx}']`);
            if(el) { const s=el.querySelector('span')||el; s.innerText=p; el.classList.add(p.toLowerCase()); }
            let winLine = null;
            if(TTT.variant==='normal') winLine = TTT.checkWin(TTT.board, p);
            else if(TTT.variant==='3d') winLine = TTT.checkWin3D(TTT.board, p);
            else if(TTT.variant==='ultimate') winLine = TTT.handleUlt(idx, p);
            if(winLine) TTT.end(p, winLine); else if(TTT.board.every(c=>c)) TTT.end('draw', null); else { TTT.turn = TTT.turn==='X'?'O':'X'; document.getElementById('ttt-turn').innerText = `Turn: ${TTT.turn}`; if(TTT.variant==='ultimate') TTT.highlightUlt(); }
        },
        checkWin: (b, p) => { const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(let w of wins) if(w.every(i => b[i]===p)) return w; return null; },
        checkWin3D: (b, p) => { for(let line of TTT.winLines3D) if(b[line[0]]===p && b[line[1]]===p && b[line[2]]===p) return line; return null; },
        handleUlt: (idx, p) => { const s = Math.floor(idx/9); const sub = TTT.board.slice(s*9, s*9+9); if(TTT.checkWin(sub, p) && !TTT.ultMacro[s]) { TTT.ultMacro[s] = p; document.getElementById(`sub-${s}`).classList.add(p==='X'?'won-x':'won-o'); } const next = idx % 9; TTT.activeSubGrid = (TTT.ultMacro[next] || TTT.board.slice(next*9, next*9+9).every(c=>c)) ? -1 : next; return TTT.checkWin(TTT.ultMacro, p); },
        highlightUlt: () => { for(let i=0;i<9;i++){ const el = document.getElementById(`sub-${i}`); el.classList.remove('active-zone'); if(!TTT.ultMacro[i] && (TTT.activeSubGrid===-1 || TTT.activeSubGrid===i)) el.classList.add('active-zone'); } },
        botMove: () => {
            let moves=[]; TTT.board.forEach((c,i)=>{ if(!c) moves.push(i) });
            if(TTT.variant==='ultimate') moves=moves.filter(i=>{const s=Math.floor(i/9); return TTT.activeSubGrid===-1||TTT.activeSubGrid===s;});
            if(moves.length===0) return;
            let chosen = moves[0];
            if (TTT.difficulty === 'easy') chosen = moves[Math.floor(Math.random() * moves.length)];
            else if (TTT.difficulty === 'medium') chosen = Math.random() > 0.4 ? TTT.getBestMove(moves) : moves[Math.floor(Math.random() * moves.length)];
            else chosen = TTT.getBestMove(moves);
            TTT.move(chosen, 'O');
        },
        getBestMove: (available) => {
            for (let m of available) { let temp = [...TTT.board]; temp[m] = 'O'; if ((TTT.variant==='3d'?TTT.checkWin3D(temp,'O'):TTT.checkWin(temp,'O'))) return m; }
            for (let m of available) { let temp = [...TTT.board]; temp[m] = 'X'; if ((TTT.variant==='3d'?TTT.checkWin3D(temp,'X'):TTT.checkWin(temp,'X'))) return m; }
            return available[Math.floor(Math.random() * available.length)];
        },
        end: (res, winLine) => {
            TTT.active = false; document.getElementById('ttt-turn').innerText = res==='draw'?"Draw!":`${res} Wins!`;
            if(res==='draw') { TTT.scores.draw++; TTT.nextStarter = TTT.currentStarter === 'X' ? 'O' : 'X'; } else { if(res==='X') TTT.scores.p1++; else TTT.scores.p2++; TTT.nextStarter = res==='X'?'O':'X'; }
            document.getElementById('p1-score').innerText = `P1: ${TTT.scores.p1}`; document.getElementById('p2-score').innerText = `P2: ${TTT.scores.p2}`;
            if(res !== 'draw' && winLine) { if(TTT.animationsEnabled && TTT.variant==='3d') { document.getElementById('board-3d').classList.add('stacked'); setTimeout(() => { TTT.drawWinLine(winLine); }, 1200); } else if(TTT.animationsEnabled) { TTT.drawWinLine(winLine); } }
            setTimeout(() => document.getElementById('ttt-restart').style.display='block', 800);
        },
        drawWinLine: (indices) => {
            if(!indices || indices.length===0 || TTT.variant==='ultimate') return;
            const startIdx = indices[0]; const endIdx = indices[indices.length-1];
            const getCenter = (idx) => {
                let el; if(TTT.variant==='normal') el=document.querySelector(`#board-normal .ttt-cell[data-idx='${idx}']`); else el=document.querySelector(`.layer-3d .ttt-cell[data-idx='${idx}']`);
                if(!el) return {x:0,y:0};
                const r = el.getBoundingClientRect(); const wr = document.getElementById('game-wrapper').getBoundingClientRect();
                return { x: r.left+r.width/2 - wr.left, y: r.top+r.height/2 - wr.top };
            };
            const s = getCenter(startIdx); const e = getCenter(endIdx);
            const path = document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d', `M ${s.x} ${s.y} L ${e.x} ${e.y}`); path.setAttribute('class', 'win-path'); document.getElementById('win-line-svg').appendChild(path);
        },
        restart: () => { TTT.initBoard(); },
        host: () => { document.getElementById('ttt-mp-setup').style.display='none'; document.getElementById('ttt-host-wait').style.display='block'; const hostId = (l=> {const c='ABCDEF0123456789'; let r=''; for(let i=0;i<l;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r;})(9); TTT.peer = new Peer(hostId, {config:{'iceServers':[{url:'stun:stun.l.google.com:19302'}]}}); TTT.peer.on('open', id => document.getElementById('host-code').innerText=id); TTT.peer.on('connection', c => { TTT.conn = c; TTT.conn.on('data', d => { if(d.type==='move') TTT.move(d.idx, TTT.myPlayer==='X'?'O':'X'); }); document.getElementById('host-status').innerText = "Connected!"; setTimeout(() => { TTT.conn.send({type:'start', v:'normal'}); TTT.startGame('normal'); }, 1000); }); },
        join: () => { const code = document.getElementById('join-code').value.trim().toUpperCase(); if(code.length !== 9) return alert("Code must be 9 chars."); TTT.peer = new Peer(null, {config:{'iceServers':[{url:'stun:stun.l.google.com:19302'}]}}); TTT.peer.on('open', () => { TTT.conn = TTT.peer.connect(code); TTT.conn.on('data', d => { if(d.type==='start'){ TTT.myPlayer='O'; TTT.startGame(d.v); } if(d.type==='move') TTT.move(d.idx, TTT.myPlayer==='X'?'O':'X'); }); }); },
        copyLink: () => { const id = document.getElementById('host-code').innerText; if(id === 'Generating...') return; navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?join=' + id).then(() => { const t = document.getElementById('toast'); t.style.visibility="visible"; setTimeout(() => t.style.visibility="hidden", 3000); }); }
    };

    // Auto-Join
    window.addEventListener('DOMContentLoaded', () => { const joinCode = new URLSearchParams(window.location.search).get('join'); if (joinCode) { Suite.loadGame('ttt'); TTT.setup('mp'); document.getElementById('join-code').value = joinCode; } });
    document.getElementById('anim-toggle').addEventListener('change', (e) => TTT.animationsEnabled = e.target.checked);
</script>
</body>
</html>
